From 3dd97e4e55735b6efbcbd13d8c59653b227951a4 Mon Sep 17 00:00:00 2001
From: Christian Kandeler <christian.kandeler@qt.io>
Date: Fri, 4 Nov 2016 12:11:44 +0100
Subject: [PATCH] Fix potential null pointer access in build graph loader

Task-number: QBS-1031
Change-Id: I8cff742317583f98dff5f6f2a26963ee4bf5d46a
Reviewed-by: Jake Petroules <jake.petroules@qt.io>
---
 src/lib/corelib/buildgraph/buildgraphloader.cpp | 2 +-
 tests/auto/blackbox/tst_blackbox.cpp            | 7 ++++---
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/src/lib/corelib/buildgraph/buildgraphloader.cpp b/src/lib/corelib/buildgraph/buildgraphloader.cpp
index a0b7697..f77f7c6 100644
--- a/src/lib/corelib/buildgraph/buildgraphloader.cpp
+++ b/src/lib/corelib/buildgraph/buildgraphloader.cpp
@@ -114,7 +114,7 @@ BuildGraphLoadResult BuildGraphLoader::load(const TopLevelProjectPtr &existingPr
     if (!m_result.loadedProject)
         return m_result;
     if (parameters.restoreBehavior() == SetupProjectParameters::RestoreOnly) {
-        foreach (const ErrorInfo &e, existingProject->warningsEncountered)
+        foreach (const ErrorInfo &e, m_result.loadedProject->warningsEncountered)
             m_logger.printWarning(e);
         return m_result;
     }
diff --git a/tests/auto/blackbox/tst_blackbox.cpp b/tests/auto/blackbox/tst_blackbox.cpp
index a528072..1deccb3 100644
--- a/tests/auto/blackbox/tst_blackbox.cpp
+++ b/tests/auto/blackbox/tst_blackbox.cpp
@@ -3476,12 +3476,13 @@ void TestBlackbox::installedApp()
     QCOMPARE(runQbs(QbsRunParameters(QStringList("--no-install"))), 0);
     QCOMPARE(QDir(defaultInstallRoot).entryList(QDir::NoDotAndDotDot).count(), 0);
 
-    // Check --no-build
-    rmDirR(relativeBuildDir());
+    // Check --no-build (with and without an existing build graph)
     QbsRunParameters params("install", QStringList("--no-build"));
+    QCOMPARE(runQbs(params), 0);
+    rmDirR(relativeBuildDir());
     params.expectFailure = true;
     QVERIFY(runQbs(params) != 0);
-    QVERIFY(m_qbsStderr.contains("No build graph"));
+    QVERIFY2(m_qbsStderr.contains("No build graph"), m_qbsStderr.constData());
 }
 
 void TestBlackbox::installDuplicates()
-- 
2.7.4

